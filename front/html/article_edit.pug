extends layout

block js
    script(type="text/javascript" src="/js/jsForAllJade.js")
    script(type="text/javascript" src="/js/updateArticle.js")
    script(type="text/javascript" src='/js/editArticle.js')
    script(src="../../public/b-editor/b-editor.js")

block css
    link(rel="stylesheet" href="../css/penobrol_add.css" type="text/css")

block submain
    //.ad Advertisement

block main
    article
        p
            - const mainColumn = article['title'] ? article['title'] : article['question'];
            input(id="mainColumn" type='text' placeholder='title' class="title" value=mainColumn)
        p.infoP
            span(id='mainColumnInfo' class='infoSpan')
        p
            if article['public'] === 'p'
                label
                    input(id='rbP' type='radio' value='p' name="public" checked)
                    span  public
                label
                    input(id='rbA' type='radio' value='a' name="public")
                    span  anonymous
            else
                label
                    input(id='rbP' type='radio' value='p' name="public")
                    span  public
                label
                    input(id='rbA' type='radio' value='a' name="public" checked)
                    span  anonymous
        p
            input(id='thumbnail' type='text' placeholder='thumbnail' maxlength="200" class='thumbnail' value=article['thumbnail'])
        p.infoP
            span(id='thumbnailInfo' class='infoSpan')
        p
            b-editor(id='editor' width="90%" height="600px" name="content")
        script.
            const edit_iframe = document.getElementById("iframe");
            edit_iframe.contentWindow.document.body.innerHTML = "#{article['content']}"
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&amp;/g, '&')
                .replace(/&quot;/g, '\"');
        p
            - const hashtags = article['hashtags'].map(e => `#${e.hash}`).join(" ");
            input(id='hashtag' type='text' name='hashtag' class="hashtag" value=hashtags)
        p.infoP
            span(id='hashtagInfo' class='infoSpan') 20/20
        p
            button(id='btnSubmit', class="submit") share
        script.
            const mainColumnMaxLength = 200;
            const thumbnailMaxLength = 200;
            const hashtagsMaxCount = 20;

            function getMainColumn() {
                return document.getElementById('mainColumn').value;
            }

            function getThumbnail() {
                return document.getElementById('thumbnail').value;
            }

            function getContent() {
                return document.getElementById('content').value;
            }

            function getHashtags() {
                return document.getElementById('hashtag').value
                    .split('#')
                    .map(function (it) {
                        return it.trim();
                    });
            }

            function updateMainColumnInfo() {
                const remaining = mainColumnMaxLength - getMainColumn().length;
                document.getElementById('mainColumnInfo').innerHTML = `${remaining}/${mainColumnMaxLength}`;
            }

            function updateThumbnailInfo() {
                const remaining = thumbnailMaxLength - getThumbnail().length;
                document.getElementById('thumbnailInfo').innerHTML = `${remaining}/${thumbnailMaxLength}`;
            }

            function updateHashtagInfo() {
                const remaining = hashtagsMaxCount - getHashtags().length;
                document.getElementById('hashtagInfo').innerHTML = `${remaining}/${hashtagsMaxCount}`;
            }

            function checkSubmit() {
                if (getMainColumn().length < 5) {
                    alert('judulnya harus lebih dari 5 alphabet');
                    return false;
                }
                if (getContent().length < 5) {
                    alert('kontennya harus lebih dari 5 alphabet');
                    return false;
                }
                return true;
            }

            window.addEventListener('load', function () {
                updateMainColumnInfo();
                updateThumbnailInfo();
                updateHashtagInfo();

                document.getElementById('btnSubmit').onclick = function () {
                    if (checkSubmit())
                        postEditArticle('#{type}');
                };

                const inputMainColumn = document.getElementById('mainColumn');
                const inputThumbnail = document.getElementById('thumbnail');
                const inputHashtag = document.getElementById('hashtag');

                inputMainColumn.onkeydown = function (e) {
                    if (getMainColumn().length >= mainColumnMaxLength)
                        e.preventDefault();
                };
                inputThumbnail.onkeydown = function (e) {
                    if (getThumbnail().length >= thumbnailMaxLength)
                        e.preventDefault();
                };
                inputHashtag.onkeydown = function (e) {
                    if (getHashtags().length >= hashtagsMaxCount && e.key === '#')
                        e.preventDefault();
                };

                inputMainColumn.onkeyup = updateMainColumnInfo;
                inputThumbnail.onkeyup = updateThumbnailInfo;
                inputHashtag.onkeyup = updateHashtagInfo;
            });
